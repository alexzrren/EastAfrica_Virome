library(tidyverse)library(ggplot2)library(vegan)library(ape)library(readxl)library(ggpubr)library(geosphere)keep_samples <- read.table('/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/ViralStrain_PopGenome/kept_vs2samp.tsv')colnames(keep_samples) <- c('vsname', 'sn')num_snps <- read_table('/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/ViralStrain_PopGenome/num_snps.tsv', col_names = F)colnames(num_snps) <- c('vsname', 'n_snps')requantdf <- read_excel('/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/Tables/3_Requantification_v1.2.xlsx')indv_rmdup <- keep_samples |>  left_join(requantdf, by=c('sn', 'vsname')) |>  arrange(desc(RPM)) |>  distinct(vsname, Inferred_Individual, .keep_all = T)stat <- indv_rmdup |>  group_by(vsname) |>  summarise(    n_samples = n(),    n_individuals = n_distinct(Inferred_Individual),    n_gps = n_distinct(revised_gps),    n_gcluster = n_distinct(revised_gcluster)  ) |>  left_join(num_snps)stat_filtered <- stat |>  filter(    n_individuals >= 5,    n_gps >=2,    n_snps >= 10  )result <- data.frame()data_long <- data.frame()for (vs in stat_filtered$vsname){  print(vs)  vsrequantdf <- indv_rmdup |>    filter(vsname==vs)    visus.genodist.matx.raw <- dist.dna(read.FASTA(paste('/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/ViralStrain_PopGenome/consensus_SNPseq/', vs, '.fasta', sep='')),           as.matrix = T, pairwise.deletion = T, model = 'raw')  visus.genodist.matx.raw.kept <- visus.genodist.matx.raw[vsrequantdf$sn, vsrequantdf$sn]  visus.genodist.matx.k80 <- dist.dna(read.FASTA(paste('/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/ViralStrain_PopGenome/consensus_SNPseq/', vs, '.fasta', sep='')),                                      as.matrix = T, pairwise.deletion = T)  visus.genodist.matx.k80.kept <- visus.genodist.matx.k80[vsrequantdf$sn, vsrequantdf$sn]      sample_gps_df <- vsrequantdf |>    select(sn, revised_gps) |>    separate(col = revised_gps, into = c("Lat", "Lon"), sep = ",") # separate gps coord string into longitude and latitude    sample.geodist.matx <- sample_gps_df |>    select(Lon, Lat) |>    as.data.frame() |>    mutate(      Lon = as.numeric(Lon),      Lat = as.numeric(Lat)    ) |>    select(Lon, Lat) |>    distm(fun=distVincentyEllipsoid)       rownames(sample.geodist.matx) <- sample_gps_df$sn # add row and col names  colnames(sample.geodist.matx) <- sample_gps_df$sn  sample.geodist.matx.kept <- sample.geodist.matx[vsrequantdf$sn, vsrequantdf$sn] # sub-matrix     mantel_test_K80 <- mantel(visus.genodist.matx.k80.kept, sample.geodist.matx.kept, method = "spearman", permutations = 999,          strata = NULL, na.rm = T, parallel = 8)  mantel_test_raw <- mantel(visus.genodist.matx.raw.kept, sample.geodist.matx.kept, method = "spearman", permutations = 999,                         strata = NULL, na.rm = T, parallel = 8)    row <- data.frame(vs, mantel_test_K80$statistic, mantel_test_K80$signif, mantel_test_raw$statistic, mantel_test_raw$signif)  result <- rbind(result, row)    upper_tri_indices <- which(upper.tri(visus.genodist.matx.raw.kept, diag = TRUE))  upper_tri_values <- visus.genodist.matx.raw.kept[upper_tri_indices]  # 获取上三角矩阵的值  row_indices <- rownames(visus.genodist.matx.raw.kept)[row(visus.genodist.matx.raw.kept)[upper_tri_indices]]  # 获取上三角矩阵的行索引和列索引  col_indices <- colnames(visus.genodist.matx.raw.kept)[col(visus.genodist.matx.raw.kept)[upper_tri_indices]]  triplet_data <- data.frame(sn1 = row_indices, sn2 = col_indices, genodist = upper_tri_values) |> # 创建三元组数据框    filter(sn1!=sn2)  triplet_data$vsname <- vs  data_long <- rbind(data_long, triplet_data)}result |>  left_join(stat_filtered, by=c('vs'='vsname')) |>  arrange(n_snps) |>  mutate(    raw_signif = cut(mantel_test_raw.signif, breaks=c(0,0.0001,0.01,0.05,1), labels = c("***","**","*","NS")),    k80_signif = cut(mantel_test_K80.signif, breaks=c(0,0.0001,0.01,0.05,1), labels = c("***","**","*","NS"))    ) |>  write_csv('/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/ViralStrain_PopGenome/EA_IntraVSgenodict_Geodict_MantelTest.csv')