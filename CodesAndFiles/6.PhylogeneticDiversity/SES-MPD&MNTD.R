library(ggplot2)library(picante)library(tidyverse)library(readxl)library(ggtree)library(data.table)library(scales)library(ggpubr)library(ggsci)df_seqid2vsname <- read_xlsx('/Users/zirui/BGI_Projects/WIV_EastAfrica/Picante_test/Assembly_sequences.xlsx')df_requant <- read_xlsx('/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/Tables/3_Requantification_v1.3.xlsx')merged <- df_requant |>  left_join(df_seqid2vsname, by = 'vsname') |>  left_join(unique(select(read.csv('/Users/zirui/BGI_Projects/WIV_EastAfrica/Picante_test/hspec2hfamily.tsv'), Final_species, Host_Family)))merged_subcol_rmdup <- merged |>  select(Host_Family, vfamily, vsname)|>  distinct(Host_Family, vsname, .keep_all = TRUE)hf2vf_max <- table(merged_subcol_rmdup$Host_Family, merged_subcol_rmdup$vfamily) |> apply(2, max)torun_vfamily <- names(hf2vf_max[hf2vf_max >= 3])calc_ses = function(vfamily, table){  print(vfamily)  phy <- read.tree(paste('/Users/zirui/BGI_Projects/WIV_EastAfrica/Picante_test/treefiles/',vfamily,'.treefile', sep=''))  table$source <- 'EA'  merged_use <- table[table$vfamily == vfamily & table$PhylogenicTree_SeqID %in% phy$tip.label,]  comm <- table(merged_use$Host_Family, merged_use$PhylogenicTree_SeqID)  comm_full <- table(merged_use$source, merged_use$PhylogenicTree_SeqID)  rownames(comm_full) <- c('EA')  phydist <- cophenetic(phy)  comm <- rbind(comm_full, comm)  ses.mpd.result <- ses.mpd(comm, phydist, null.model="taxa.labels", abundance.weighted=FALSE, runs=1000)  #mpd.result <- mpd(comm, phydist, null.model='taxa.labels', abundance.weighted = FALSE, runs=1000)  ses.mntd.result <- ses.mntd(comm, phydist, null.model="taxa.labels", abundance.weighted=FALSE, runs=1000)  ses.result <- cbind(ses.mpd.result, ses.mntd.result)   ses.result$vfamily <- vfamily  ses.result$host_family <- rownames(ses.result)  comdist.result <- comdist(comm, phydist)  comdist.clusters <- hclust(comdist.result)  ggtree(comdist.clusters, size=0.3) +    geom_tiplab(size=2)+    labs(title=vfamily)+    theme_tree2()+    theme(      plot.title = element_text(hjust = 0.5, vjust = -3, color = 'black', size=10)    )  ggsave(paste('/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/Plot/Fig04_PhylogeneticDiversity/Picante_dendrogram/',vfamily,'.pdf', sep=''), height = 2, width = 2.8)  list(ses.result, comdist.result)}mpd_allresult <- lapply(torun_vfamily, function(vf) calc_ses(vf, merged))result <- rbindlist(lapply(mpd_allresult, function(a) a[[1]]))colnames(result) <- make.unique(names(result))write.csv(result, '/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/Plot/Fig04_PhylogeneticDiversity/ses_result.csv')# matrix bubble plot# cut by significance levelresult$mpd_sig <- cut(result$mpd.obs.p, breaks=c(0,0.01,0.05,1), labels = c("P<0.01","P<0.05","Not significant"))result$mntd_sig <- cut(result$mntd.obs.p, breaks=c(0,0.01,0.05,1), labels = c("P<0.01","P<0.05","Not significant"))# MPDresult |>  mutate(mpd.obs.z.abs = abs(mpd.obs.z)) |>  na.omit() |>    ggplot()+  geom_point(aes(x=vfamily, y=host_family, fill=mpd.obs.z,                  size=mpd.obs.z.abs, color=mpd_sig, stroke=1), shape=21)+  scale_fill_gradientn(colours = c("DodgerBlue1","white","DarkOrange1"),                        values = rescale(c(-11,0,2.5)),                       guide = "colorbar", limits=c(-11,2.5), breaks = c(2.5,0,-2.5,-5,-7.5,-10))+  scale_color_manual(values = c("NavyBlue","royalblue1","lightgray"))+  theme_bw()+  labs(x = expression('Viral family'), y = expression('Bat family'), title='SES MPD')+  theme(    axis.text.x = element_text(angle = 30, hjust=1, vjust = 1, color='black'),    axis.text.y = element_text(color='black'),    axis.title.x = element_text(color='black', size=12),    axis.title.y = element_text(color='black', size=12)  )ggsave('/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/Plot/Fig04_PhylogeneticDiversity/Fig4c.SES_MPD.pdf', height = 10.8/2.2, width = 12/2.2)# MNTDp.mntd <- ggplot(na.omit(result))+  geom_point(aes(x=vfamily, y=host_family, fill=mntd.obs.z,                 size=abs(mntd.obs.z), color=mntd_sig, stroke=1), shape=21)+  scale_fill_gradientn(colours = c("DodgerBlue1","white","DarkOrange1"),                        values = rescale(c(-6,0,2)),                       guide = "colorbar", limits=c(-6,2), breaks = c(2,0,-2,-4,-6))+  scale_color_manual(values = c("NavyBlue","royalblue1","lightgray"))+  theme_bw()+  labs(x = expression('Viral family'), y = expression('Bat family'), title='SES MNTD')+  theme(    axis.text.x = element_text(angle = 30, hjust=1, vjust = 1, color='black'),    axis.text.y = element_text(color='black'),    axis.title.x = element_text(color='black', size=12),    axis.title.y = element_text(color='black', size=12)  )p.mntdggsave('/Users/zirui/BGI_Projects/WIV_EastAfrica/Picante_test/SES_MNTD.pdf', height = 10.8/2.2, width = 12/2.2)