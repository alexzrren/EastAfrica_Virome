# picante testlibrary(ggplot2)library(picante)library(tidyverse)library(readxl)library(ggtree)library(data.table)library(scales)library(ggpubr)library(ggsci)df_seqid2vsname <- read_xlsx('/Users/zirui/BGI_Projects/WIV_EastAfrica/Picante_test/Assembly_sequences.xlsx')df_requant <- read_xlsx('/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/Tables/3_Requantification_v1.3.xlsx')#df_requant_bat <- df_requant[df_requant$host_type == 'Bat',]merged <- df_requant |>  left_join(df_seqid2vsname, by = 'vsname') |>  mutate(host_genus = str_split_i(Final_species, ' ', 1))merged_subcol_rmdup <- merged |>  select(host_genus, vfamily, vsname)|>  distinct(host_genus, vsname, .keep_all = TRUE)hf2vf_max <- table(merged_subcol_rmdup$host_genus, merged_subcol_rmdup$vfamily) |> apply(2, max)torun_vfamily <- names(hf2vf_max[hf2vf_max >= 3])calc_ses = function(vfamily, table){  print(vfamily)  phy <- read.tree(paste('/Users/zirui/BGI_Projects/WIV_EastAfrica/Picante_test/treefiles/',vfamily,'.treefile', sep=''))  table$source <- 'EA'  merged_use <- table[table$vfamily == vfamily & table$PhylogenicTree_SeqID %in% phy$tip.label,]  comm <- table(merged_use$host_genus, merged_use$PhylogenicTree_SeqID)  comm_full <- table(merged_use$source, merged_use$PhylogenicTree_SeqID)  rownames(comm_full) <- c('EA')  phydist <- cophenetic(phy)  comm <- rbind(comm_full, comm)  #mpd.result <- mntd(comm, phydist)  mpd.result <- mpd(comm, phydist)  names(mpd.result) <- rownames(comm)  df.mpd.result <- data.frame(mpd.result)  colnames(df.mpd.result) <- vfamily  df.mpd.result$genus <- rownames(comm)    comdist.result <- comdist(comm, phydist)  comdist.clusters <- hclust(comdist.result)  ggtree(comdist.clusters, size=0.3) +    geom_tiplab(size=2)+    xlim(0,max(comdist.clusters$height)*0.7) +    labs(title=vfamily)+    theme_tree2()+    theme(      plot.title = element_text(hjust = 0.5, vjust = -3, color = 'black', size=10)    )  #ggsave(paste('/Users/zirui/BGI_Projects/WIV_EastAfrica/Picante_test/vfamily_dendrogram/',vfamily,'.pdf', sep=''), height = 2, width = 2.8)  melt(df.mpd.result)}torun_vfamily <- c('Astroviridae','Caliciviridae','Circoviridae','Coronaviridae','Papillomaviridae','Parvoviridae','Picornaviridae')torun_vfamily_full <- c("Astroviridae","Caliciviridae","Circoviridae","Coronaviridae","Flaviviridae","Herpesviridae","Papillomaviridae","Paramyxoviridae","Parvoviridae","Picornaviridae","Polyomaviridae","Reoviridae")mpd_allresult <- lapply(torun_vfamily_full, function(vf) calc_ses(vf, merged))result <- as_tibble(rbindlist(mpd_allresult))result |>  filter(genus != 'EA' ) |>  filter(!(is.na(value))) |>  ggplot(aes(x=fct_relevel(variable, as.vector(sort(unique(variable), decreasing = T))), y=value)) +  geom_boxplot(aes(fill=variable), width =0.7, fill='#8DC4DF') +  theme_classic()+  labs(x='Viral family', y='MPD') +  scale_y_continuous(breaks = seq(0,8,1))+  theme(    axis.text.x = element_text(size=12, color='black'),    axis.text.y = element_text(color='black', size=14, face='italic'),    axis.title.x = element_text(color='black', size=16, face='bold'),    axis.title.y = element_text(color='black', size=16, face='bold'),    legend.position = 'none'  ) +  coord_flip()ggsave('/Users/zirui/BGI_Projects/WIV_EastAfrica_Clean/Plot/Fig04_PhylogeneticDiversity/Fig4b.MPD-ViralFamily_singlecolor.pdf', width = 6, height = 4)result |>  filter(genus != 'EA' ) |>  filter(!(is.na(value))) |>  mutate(value_log10 = log10(value))